name: E2E Android Detox

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  detox-e2e-android:
    runs-on: macos-latest

    env:
      AVD_NAME: test
      API_LEVEL: 33
      ABI: x86_64
      TARGET: "google_apis"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '22.15.0'

      - name: Install pnpm
        run: npm install -g pnpm@10.11.0

      - name: Install dependencies
        run: pnpm install

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17

      - name: Setup Android SDK + Create AVD
        run: |
          echo "üõ† Instalando system image y cmdline-tools"
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --sdk_root=$ANDROID_HOME --install \
            "platform-tools" \
            "emulator" \
            "cmdline-tools;latest" \
            "system-images;android-${API_LEVEL};${TARGET};${ABI}"

          echo "üîß Configurando entorno"
          export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/emulator:$ANDROID_HOME/platform-tools:$PATH

          echo "üì± Creando AVD: $AVD_NAME"
          echo "no" | avdmanager create avd -n $AVD_NAME -k "system-images;android-${API_LEVEL};${TARGET};${ABI}" --force

      - name: Launch Emulator
        run: |
          export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/emulator:$ANDROID_HOME/platform-tools:$PATH
          echo "üöÄ Iniciando emulador $AVD_NAME"
          $ANDROID_HOME/emulator/emulator -avd $AVD_NAME -no-snapshot -no-window -no-audio -no-boot-anim -gpu swiftshader_indirect &

          echo "‚è≥ Esperando que el emulador inicie..."
          adb wait-for-device
          boot_completed=""
          until [[ "$boot_completed" == "1" ]]; do
            sleep 5
            boot_completed=$(adb shell getprop sys.boot_completed | tr -d '\r')
            echo "üïí boot_completed=$boot_completed"
          done

          adb shell input keyevent 82

      - name: Build Detox
        run: pnpm detox build --configuration android.emu.release
        env:
          RCT_NO_LAUNCH_PACKAGER: true

      - name: Detox test - Inicio de sesi√≥n
        run: pnpm detox test --configuration android.emu.release --headless --record-logs all --testPathPattern=e2e/tests/Flujo\ de\ inicio\ de\ sesi√≥n

      - name: Detox test - Resto de pruebas
        run: pnpm detox test --configuration android.emu.release --headless --record-logs all --testPathIgnorePatterns=e2e/tests/Flujo\ de\ inicio\ de\ sesi√≥n --reuse
